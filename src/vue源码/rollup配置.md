# rollupé…ç½®



## githubåœ°å€

> https://github.com/WONISHI/vue-source-code

## vue2çš„github

> https://github.com/vuejs/vue

## åˆå§‹åŒ–é¡¹ç›®

```js
npm init -y
```

## å®‰è£…ä¾èµ–

* @babel/preset-env
* @babel/core
* rollup
* rollup-plugin-babel
* rollup-plugin-serve -D

```JS
npm install @babel/preset-env @babel/core rollup rollup-plugin-babel rollup-plugin-serve -D
```



**å®‰è£…ç›¸å…³ä¾èµ–ï¼ˆvue2æºä»£ç ä¸­å®‰è£…çš„ä¾èµ–ï¼‰**

| ä¾èµ–                        | ç‰ˆæœ¬   | è¯´æ˜                                                         | å¤‡æ³¨ |
| --------------------------- | ------ | ------------------------------------------------------------ | ---- |
| @babel/parser               | 7.23.5 | å°† JavaScript ä»£ç è§£æï¼ˆparseï¼‰æˆæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰           |      |
| @rollup/plugin-alias        | 3.1.9  | è®¾ç½®åˆ«å                                                     |      |
| @rollup/plugin-commonjs     | 22.0.0 | å°†commonjsæ¨¡å—è½¬æ¢ä¸ºesæ¨¡å—                                   |      |
| @rollup/plugin-replace      | 4.0.0  | æ›¿æ¢ä»£ç ä¸­çš„å˜é‡                                             |      |
| @rollup/plugin-node-resolve |        |                                                              |      |
| @babel/core                 |        |                                                              |      |
| rollup                      |        |                                                              |      |
| rollup-plugin-serve         |        |                                                              | x    |
| rollup-plugin-babel         |        | è®©ä½ åœ¨ä½¿ç”¨ Rollup æ‰“åŒ… JavaScript æˆ– TypeScript æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Babel è½¬æ¢ä»£ç ï¼ˆå¦‚ ES6+ â†’ ES5ã€JSX â†’ JSã€TypeScript â†’ JS ç­‰ï¼‰ | x    |



â“â“â“Vue 2 æºç ä¸ºä»€ä¹ˆæ²¡æœ‰ç”¨ `rollup-plugin-babel` çš„åŸå› å¦‚ä¸‹ï¼š

âœ… 1. **Vue 2 ä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰æ„å»ºæµç¨‹**

Vue 2 çš„æºç æ„å»ºç”¨çš„æ˜¯ **Rollup**ï¼Œä½†å®ƒä½¿ç”¨äº†æ›´åº•å±‚æˆ–å®šåˆ¶çš„æ„å»ºæ–¹å¼ï¼š

- å®ƒå¹¶æ²¡æœ‰é‡‡ç”¨æ ‡å‡†çš„ Babel æ’ä»¶æ–¹å¼ï¼ˆå¦‚ `rollup-plugin-babel`ï¼‰ï¼Œ
- è€Œæ˜¯é€šè¿‡å†…éƒ¨è„šæœ¬æˆ–è‡ªå®šä¹‰æ–¹å¼è°ƒç”¨ Babel è½¬è¯‘éƒ¨åˆ†æ¨¡å—ï¼ˆå°¤å…¶æ˜¯å¯¹ ES2015 æ¨¡å—å’Œ UMD æ¨¡å—çš„è¾“å‡ºï¼‰ï¼Œ
- å¹¶æ ¹æ®ç›®æ ‡å¹³å°é€‰æ‹©ä¸åŒçš„ç¼–è¯‘ç­–ç•¥ï¼ˆä¾‹å¦‚ ES module / CommonJS / IIFE / Runtime-only / Compiler åŒ…ç­‰ï¼‰ã€‚

ğŸ‘‰ åœ¨ Vue 2 æºç ç›®å½•ä¸­ï¼ˆå¦‚ `scripts/config.js`ï¼‰ä½ ä¼šçœ‹åˆ°å¾ˆå¤š Rollup æ„å»ºé…ç½®ï¼Œä½†æœªç›´æ¥ç”¨ `rollup-plugin-babel`ã€‚



âœ… 2. **Vue 2 çš„æºç æ˜¯æ‰‹å†™å…¼å®¹ ES5 çš„ä»£ç **

Vue 2 çš„å¤§éƒ¨åˆ†æºç æ˜¯ï¼š

- **æ‰‹å†™çš„ ES5 æˆ–å…¼å®¹æ€§å¾ˆå¼ºçš„ ES2015**
- å› æ­¤å¾ˆå¤šæ¨¡å—**ä¸éœ€è¦ Babel è½¬è¯‘**ï¼Œè¿™ä¹Ÿæ˜¯å®ƒèƒ½è¿è¡Œåœ¨ IE9 çš„åŸå› ä¹‹ä¸€



âœ… 3. ğŸ§© **Vue 2 çš„æ„å»ºç›®æ ‡æ˜¯å¤šæ ¼å¼è¾“å‡ºï¼Œä¸ä¾èµ– Babel ç»Ÿä¸€å¤„ç†**

Vue 2 ä¼šæ„å»ºå¤šä¸ªç‰ˆæœ¬ï¼š

- `vue.runtime.esm.js`
- `vue.runtime.min.js`
- `vue.common.js`
- `vue.global.js`
- `vue.js`ï¼ˆå®Œæ•´ç‰ˆï¼‰

æ¯ä¸ªç‰ˆæœ¬çš„æ„å»ºç­–ç•¥ä¸åŒï¼Œæœ‰äº›æ˜¯ç›´æ¥æ‰“åŒ…æºç ï¼Œæœ‰äº›æ˜¯å¸¦ç¼–è¯‘å™¨ï¼Œæœ‰äº›æ˜¯ä¼˜åŒ– tree-shakingã€‚

è¿™äº›æ„å»ºè¿‡ç¨‹ **ä¸ä¸€å®šéƒ½ç”¨ Babel**ï¼Œæ¯”å¦‚å¯¹å…¼å®¹æ€§è¦æ±‚ä¸é«˜çš„ ESM æ„å»ºå¯èƒ½æ ¹æœ¬æ²¡ç”¨ Babelã€‚



âœ… 4. **å†å²åŸå› ï¼šVue 2 å‘å¸ƒæ—¶ Babel æ’ä»¶ç”Ÿæ€ä¸å¦‚ç°åœ¨æˆç†Ÿ**

Vue 2 æ˜¯åœ¨ **2016 å¹´å‘å¸ƒçš„**ï¼Œå½“æ—¶ï¼š

- Babel å’Œ Rollup çš„é›†æˆæ–¹æ¡ˆè¿˜ä¸ç¨³å®šï¼›
- `rollup-plugin-babel` å­˜åœ¨ä¸€äº› tree-shaking é—®é¢˜æˆ–å†²çªï¼›
- æ‰€ä»¥ä½œè€…å°¤é›¨æºªé€‰æ‹©äº†æ›´å¯é çš„æ‰‹åŠ¨æ„å»ºç­–ç•¥ã€‚



----

â“â“â“vue2æºç ä¸ºä»€ä¹ˆæ²¡æœ‰@babel/core

âœ… 1. **Vue 2 å‘å¸ƒæ—¶ Babel è¿˜åœ¨ä½¿ç”¨ 6.xï¼ˆbabel-coreï¼‰ç‰ˆæœ¬**

Vue 2 åˆå§‹å‘å¸ƒäº **2016 å¹´ï¼ˆv2.0.0ï¼‰**ï¼Œå½“æ—¶ï¼š

- Babel çš„æ ¸å¿ƒåŒ…å«åšï¼š`babel-core`ï¼ˆç‰ˆæœ¬ 6.xï¼‰
- `@babel/core` æ˜¯ **Babel 7 çš„äº§ç‰©**ï¼Œç›´åˆ° **2018 å¹´** æ‰æ¨å‡º
- æ‰€ä»¥ Vue 2 å¹¶ä¸ä¼šä¾èµ–ä¸€ä¸ªè¿˜æ²¡å‘å¸ƒçš„åŒ…

ğŸ“Œ Vue 2 çš„æ„å»ºè„šæœ¬ä¸­ï¼Œå¦‚æœ‰ Babel è½¬è¯‘æ“ä½œï¼Œç”¨çš„ä¹Ÿä¼šæ˜¯æ—§ç‰ˆçš„ `babel-core`ï¼Œä¸æ˜¯ `@babel/core`ã€‚



âœ… 2. **Vue 2 çš„æºç å¤§å¤šæ˜¯æ‰‹å†™å…¼å®¹ ES5 çš„ JavaScript**

Vue 2 çš„æºç ç»“æ„å’Œå†™æ³•ç‰¹ç‚¹ï¼š

- ç»å¤§éƒ¨åˆ†æ˜¯æ‰‹å†™ ES5 æˆ–éå¸¸åŸºç¡€çš„ ES2015ï¼ˆä¾‹å¦‚ `var`, `function`, `module.exports`ï¼‰
- å¾ˆå°‘ä½¿ç”¨ classã€async/awaitã€ç®­å¤´å‡½æ•°ç­‰éœ€è¦ Babel è½¬æ¢çš„ç‰¹æ€§
- å› æ­¤ **æ ¹æœ¬ä¸éœ€è¦ä¾èµ– Babel æ¥åšè½¬è¯‘**

æ¢å¥è¯è¯´ï¼š**æºç æœ¬èº«å°±ç›®æ ‡æ˜ç¡®ï¼Œå†™ç»™ ES5 æµè§ˆå™¨çœ‹çš„ï¼Œç›´æ¥å°±èƒ½è·‘**



âœ… 3. **æ„å»ºè¾“å‡ºå¤šæ ·ï¼ŒæŒ‰éœ€è½¬è¯‘ï¼Œä¸ä¾èµ– Babel çš„ç»Ÿä¸€å¤„ç†**

Vue 2 æ„å»ºç³»ç»Ÿè®¾è®¡éå¸¸ç²¾ç»†ï¼š

- è¾“å‡ºå¤šä¸ªæ ¼å¼ï¼šESMã€CJSã€UMDã€Runtime onlyã€å®Œæ•´ç‰ˆç­‰
- æŸäº›æ„å»ºç‰ˆæœ¬æ ¹æœ¬ä¸éœ€è¦ Babelï¼ˆæ¯”å¦‚å¼€å‘ç‰ˆï¼‰ï¼ŒæŸäº›åˆ™åªç”¨å·¥å…·é“¾å¤„ç†éƒ¨åˆ†æ¨¡å—
- è¿™æ ·ç²¾ç»†çš„æ§åˆ¶è®© Babel **å¹¶éå¿…é¡»ä¾èµ–**



âœ… 4. **Vue 2 æ„å»ºä¾èµ–æ›´å°‘ï¼Œä¾¿äºç»´æŠ¤å’Œè°ƒè¯•**

- Vue 2 è¿½æ±‚æœ€å°ä¾èµ–ï¼Œ**æ„å»ºå·¥å…·è½»é‡ç¨³å®š**
- å¦‚æœæºç è¶³å¤Ÿå…¼å®¹æ—§æµè§ˆå™¨ï¼Œ**å°±æ²¡å¿…è¦å¼•å…¥ Babel å¢åŠ æ„å»ºå¤æ‚æ€§**



âœ… æ€»ç»“

| é—®é¢˜             | Vue 2 ä¸ºä»€ä¹ˆæ²¡æœ‰ `@babel/core`ï¼Ÿ             |
| ---------------- | -------------------------------------------- |
| ğŸ”§ Babel 7 æœªå‘å¸ƒ | å‘å¸ƒåˆæœŸ Babel 7 ä¸å­˜åœ¨ï¼Œåªæœ‰ `babel-core@6` |
| ğŸ’¡ ä»£ç å…¼å®¹æ€§å¼º   | æºç æœ¬èº«å°±æ˜¯å…¼å®¹ ES5 çš„                      |
| ğŸ¯ ç²¾ç»†æ„å»ºç­–ç•¥   | Vue 2 æ„å»ºè¿‡ç¨‹ä¸ç»Ÿä¸€ä¾èµ– Babel               |
| ğŸ§± ä¿æŒæ„å»ºè½»é‡   | å‡å°‘ä¾èµ–ï¼Œæé«˜ç¨³å®šæ€§ä¸ç»´æŠ¤æ€§                 |

---

â“â“â“å¦‚æœè¯´vue2éƒ½è¯´æ„å»ºè¾“å‡ºå¤šæ ·å¹¶ä¸”è¯´æ‰‹å†™å…¼å®¹es5çš„è¯­æ³•ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å®‰è£…@babel/parserï¼Œè¿™ä¸ªåŒ…åœ¨vue2ä¸­èµ·åˆ°ä»€ä¹ˆä½œç”¨

âœ… ä¸€å¥è¯ç»“è®ºï¼š

> Vue 2 ä¸­ä½¿ç”¨ `@babel/parser` **ä¸æ˜¯ä¸ºäº†ä»£ç è½¬è¯‘æ„å»º**ï¼Œè€Œæ˜¯ä¸ºäº† **åˆ†ææ¨¡æ¿è¡¨è¾¾å¼ä¸­çš„ JavaScript è¯­æ³•**ï¼Œä¹Ÿå°±æ˜¯â€”â€”**ç¼–è¯‘é˜¶æ®µçš„é™æ€è¯­æ³•åˆ†æç”¨é€”**ã€‚

ğŸ“¦ `@babel/parser` åœ¨ Vue 2 ä¸­çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ï¼š

ğŸ” **ç”¨äºè§£ææ¨¡æ¿è¡¨è¾¾å¼ä¸­çš„ JS ä»£ç ï¼ˆé™æ€è¯­æ³•æ£€æŸ¥ï¼‰**

æ¯”å¦‚æ¨¡æ¿ä¸­å†™äº†è¿™æ ·ä¸€æ®µï¼š

```vue
<template>
  <div>{{ foo + bar }}</div>
</template>
```

è¿™æ®µ `foo + bar` ä¼šè¢« Vue çš„æ¨¡æ¿ç¼–è¯‘å™¨æå–å¹¶è½¬æ¢æˆæ¸²æŸ“å‡½æ•°çš„ä¸€éƒ¨åˆ†ï¼š

```js
with(this) {
  return _c('div', [_v(_s(foo + bar))])
}
```

ä½†ä¸ºäº†å®‰å…¨ã€å‡†ç¡®åœ°å¤„ç†æ¨¡æ¿è¡¨è¾¾å¼ä¸­çš„è¯­æ³•é”™è¯¯ï¼ŒVue éœ€è¦å…ˆ**ç”¨ `@babel/parser` æŠŠå®ƒè§£ææˆ AST**ï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼Œç„¶åå†åšè¿›ä¸€æ­¥ç¼–è¯‘æˆ–é”™è¯¯æç¤ºã€‚

ğŸ”§ åœ¨ Vue 2 ä¸­çš„å…·ä½“ä½¿ç”¨åœºæ™¯

Vue 2 ä¸­æœ‰ä¸€ä¸ªæ ¸å¿ƒåŒ…ï¼š`vue-template-compiler`ï¼ˆåˆå« `compiler-core`ï¼‰

åœ¨ç¼–è¯‘å™¨ä¸­ï¼Œ`@babel/parser` çš„ç”¨é€”æ˜¯è¿™æ ·çš„ï¼š

- å¯¹æ¨¡æ¿é‡Œçš„è¡¨è¾¾å¼è°ƒç”¨ `@babel/parser.parseExpression()` è¿›è¡Œ**è¯­æ³•åˆæ³•æ€§æ ¡éªŒ**
- æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†éæ³•å…³é”®å­—ï¼ˆå¦‚ `with`, `debugger`ï¼‰
- ç»™å‡ºç²¾ç¡®çš„è¯­æ³•é”™è¯¯æç¤ºï¼ˆå¦‚ `SyntaxError: Unexpected token`ï¼‰

ä¾‹å¦‚ï¼š

```js
import { parseExpression } from '@babel/parser'

try {
  parseExpression('foo + bar', { plugins: ['optionalChaining'] })
} catch (err) {
  console.warn('è¡¨è¾¾å¼è¯­æ³•é”™è¯¯:', err.message)
}

```

ğŸ¤” ä¸ºä»€ä¹ˆä¸ç”¨ `eval` æˆ–æ‰‹å†™æ­£åˆ™è§£æï¼Ÿ

å› ä¸ºï¼š

- æ­£åˆ™ä¸å¯é ï¼Œä¸èƒ½å¤„ç†å¤æ‚è¯­æ³•
- `eval` æœ‰å®‰å…¨é—®é¢˜ï¼Œä¸”ä¸èƒ½ç”¨äºé™æ€åˆ†æ
- `@babel/parser` æ˜¯å·¥ä¸šçº§çš„è¯­æ³•åˆ†æå™¨ï¼Œå…¼å®¹æ€§å¥½ï¼Œä¸”ä¸æ¶‰åŠä»£ç æ‰§è¡Œ



ğŸš« æ³¨æ„

Vue 2 **å¹¶æ²¡æœ‰ä½¿ç”¨ `@babel/core` åšè½¬è¯‘**
 ä½†ä½¿ç”¨äº† `@babel/parser` åšè¡¨è¾¾å¼è¯­æ³•åˆ†æ

è¿™ä¸¤ä¸ªç”¨é€”å®Œå…¨ä¸åŒï¼š

| åŒ…              | ä½œç”¨                                      |
| --------------- | ----------------------------------------- |
| `@babel/core`   | æŠŠ JS ä»£ç è½¬è¯‘ä¸ºä¸åŒè¯­æ³•æ ‡å‡†ï¼ˆES6 âœ ES5ï¼‰ |
| `@babel/parser` | ä»…åš **é™æ€è¯­æ³•è§£æä¸º AST**ï¼Œä¸åšè½¬è¯‘     |



## æ‰“åŒ…æ–‡ä»¶çš„é…ç½®

åˆ›å»ºrollup.config.js
```js
import bable from "rollup-plugin-babel"
import serve from "rollup-plugin-serve"
export default{
    input:'./src/index.js',//æ‰“åŒ…çš„å…¥å£æ–‡ä»¶
    output:{
        file:'dist/vue.js',
        format:'umd',//æ‰“åŒ…çš„æ¨¡å—ï¼Œå¯ä»¥åœ¨windowä¸Š Vue
        name:'vue',//å…¨å±€çš„Vue
        sourcemap:true,//æ˜ å°„
    },
    plugins:[
        bable({
            exclude:'node_modules/**',//æ’é™¤ä¸éœ€è¦è½¬åŒ–
        }),
        serve({
            port:3000,//è®¾ç½®ç«¯å£å·
            contentBase:'',//å¦‚æœæ˜¯''è¡¨ç¤ºå½“å‰ç›®å½•
            openPage:'/index.html',//æ‰“å¼€çš„æ–‡ä»¶
        })
    ]
}
```

## æ‰§è¡Œå‘½ä»¤

```json
{
  "name": "vue2-cli",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "dev": "rollup -c -w"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "devDependencies": {
    "@babel/core": "^7.23.0",
    "@babel/preset-env": "^7.22.20",
    "rollup": "^2.56.0",
    "rollup-plugin-babel": "^4.4.0",
    "rollup-plugin-serve": "^2.0.2"
  }
}
```

rollup.js2.56.0

## babelaé¢„è§£æ

åˆ›å»º.babelrc
```js
{
    "presets":[
        "@babel/preset-env"
    ]
}
```

## é¡µé¢ä½¿ç”¨

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div id="app"></div>
    <script src="./dist/vue.js"></script>
    <script>
        const vm=new Vue({
            data(){
                return{
                    
                }
            }
        })
        console.log(vm)
    </script>
</body>
</html>
```